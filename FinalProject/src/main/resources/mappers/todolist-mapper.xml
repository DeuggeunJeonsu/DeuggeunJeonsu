<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd" >
<mapper namespace="todolistMapper">
  
	<resultMap type="TodoList" id="list_rm">
	    <id property="listNo" column="LIST_NO"/>
	    <result property="listContent" column="LIST_CONTENT"/>
	    <result property="listFl" column="LIST_FL"/>
	    <result property="memberNo" column="MEMBER_NO"/>
	    <result property="lCreateDt" column="L_CREATE_DT"/>
	</resultMap>
  
  
  
	<select id="selectTodoListAll" resultType="map">
		SELECT
		    TO_CHAR(TD."L_CREATE_DT", 'YYYY-MM-DD') AS L_CREATE_DT, 
		    MAX(C."ALL_FL") AS ALL_FL
		FROM
		    "TODOLIST" TL
		JOIN
		    "TODOLIST_DATE" TD ON TL."LIST_NO" = TD."LIST_NO"
		JOIN
		    "CALENDER" C ON TD."L_CREATE_DT" = C."L_CREATE_DT"
		WHERE
		    TL."MEMBER_NO" = #{loginMemberNo}
		GROUP BY
		    TO_CHAR(TD."L_CREATE_DT", 'YYYY-MM-DD')
		ORDER BY
		    TO_CHAR(TD."L_CREATE_DT", 'YYYY-MM-DD')
	</select>
	 
	 
	<select id="DetailedTodoList" resultMap="list_rm">
		SELECT LIST_NO, TO_CHAR(L_CREATE_DT, 'YYYY-MM-DD')L_CREATE_DT,
		    LIST_CONTENT, LIST_FL
		FROM CALENDER
		JOIN TODOLIST_DATE USING(L_CREATE_DT)
		JOIN TODOLIST USING(LIST_NO)
		WHERE TODOLIST.MEMBER_NO = #{loginMemberNo}
		AND TO_CHAR(L_CREATE_DT, 'YYYY-MM-DD') = #{choiceTodoDate}
		ORDER BY LIST_NO
	</select>
  
  
  	<update id="todoUpdate">
	    UPDATE TODOLIST SET LIST_FL =
	    <choose>
	        <when test ="listFl == true">'Y'</when>
	        <when test ="listFl == false">'N'</when>
	        
	    </choose>
	    WHERE LIST_NO = #{listNo}
	</update>
	
	
	<delete id="todoDelete">
		DELETE  FROM "TODOLIST"
		WHERE LIST_NO= #{todoNo}
	</delete>
	
	<insert id="todoInsert" parameterType="TodoList"
		useGeneratedKeys="true">
		<selectKey order="BEFORE" resultType="_int"
			keyProperty="listNo">
			SELECT SEQ_LIST_NO.NEXTVAL FROM DUAL
		</selectKey>
		INSERT INTO "TODOLIST"
		VALUES(#{listNo},#{listContent}, DEFAULT, #{memberNo})
	</insert>
	
	<select id="calenderSelect" resultType="java.lang.String">
			SELECT
		    TO_CHAR(TD."L_CREATE_DT", 'YYYY-MM-DD')"L_CREATE_DT"
		    
		FROM
		    "TODOLIST" TL
		JOIN
		    "TODOLIST_DATE" TD ON TL."LIST_NO" = TD."LIST_NO"
		JOIN
		    "CALENDER" C ON TD."L_CREATE_DT" = C."L_CREATE_DT"
		WHERE
		    TL."MEMBER_NO" = #{memberNo}
		AND 
		    C."L_CREATE_DT" = #{lCreateDt}
		GROUP BY
		    TO_CHAR(TD."L_CREATE_DT", 'YYYY-MM-DD')
		ORDER BY
		    TO_CHAR(TD."L_CREATE_DT", 'YYYY-MM-DD')
	
	</select>
	
	
	
	
	
	<insert id="calenderInsert">
		INSERT INTO "CALENDER"
		VALUES(#{lCreateDt}, DEFAULT)
	</insert>
	
	<insert id="todoDateInsert">
		INSERT INTO "TODOLIST_DATE"
		VALUES (${listNo}, #{lCreateDt})
	</insert>
  
  	<!-- 전체 달성 -->
  	<update id="allCompleted">
  		UPDATE "CALENDER" SET ALL_FL = 'Y'
		WHERE L_CREATE_DT =  #{date}
  	
  	</update>
  	
  	
  	<!-- 일부 달성 -->
  	<update id="unfinished">
		UPDATE "CALENDER" SET ALL_FL = 'N'
		WHERE L_CREATE_DT =  #{date}
  	</update>
</mapper>
